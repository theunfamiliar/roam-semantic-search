2025-05-30 16:22:05 [    INFO] HTTP Request: GET http://test/api/health "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] HTTP Request: GET http://test/api/health/ping "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/reindex, Query Params: {}, Body: {'brain': 'ideas'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/reindex "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/reindex, Query Params: {}, Body: {'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/reindex "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test query', 'top_k': 5, 'brain': 'ideas'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test query', 'top_k': 5, 'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/reindex "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': '', 'top_k': 5}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 422 Unprocessable Entity" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'top_k': -1}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 422 Unprocessable Entity" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'invalid_brain'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 422 Unprocessable Entity" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/reindex, Query Params: {}, Body: {'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/reindex "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/reindex, Query Params: {}, Body: {'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/reindex "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test query', 'top_k': 5, 'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/reindex, Query Params: {}, Body: {'brain': 'ideas'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/reindex "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/reindex, Query Params: {}, Body: {'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/reindex "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test query', 'top_k': 10, 'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test query', 'top_k': 10, 'brain': 'ideas'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'ideas'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'invalid'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:22:05 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 422 Unprocessable Entity" (_client.py:1740)
2025-05-30 16:22:05 [    INFO] Fetching blocks under TOC - ideas (indexing.py:95)
2025-05-30 16:22:05 [    INFO] Fetching block references (indexing.py:117)
2025-05-30 16:22:05 [    INFO] Creating embeddings (indexing.py:126)
2025-05-30 16:22:05 [    INFO] Use pytorch device_name: mps (SentenceTransformer.py:211)
2025-05-30 16:22:05 [    INFO] Load pretrained SentenceTransformer: sentence-transformers/all-MiniLM-L6-v2 (SentenceTransformer.py:219)
2025-05-30 16:22:10 [    INFO] Creating FAISS index (indexing.py:130)
2025-05-30 16:22:10 [    INFO] Successfully reindexed ideas brain in 4.63 seconds (indexing.py:145)
2025-05-30 16:22:10 [    INFO] Fetching blocks under TOC - ideas (indexing.py:95)
2025-05-30 16:22:10 [   ERROR] ‚ùå Failed to reindex ideas brain (indexing.py:154)
Traceback (most recent call last):
  File "/Users/jamesdunn/Documents/roam-semantic-search/app/services/indexing.py", line 96, in reindex_brain
    blocks = await get_blocks_under_toc(toc_page)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jamesdunn/Documents/roam-semantic-search/app/utils/roam_api.py", line 57, in get_blocks_under_toc
    result = await query_roam(query, toc_page)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jamesdunn/Documents/roam-semantic-search/app/utils/roam_api.py", line 32, in query_roam
    response = await client.post(
               ^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/jamesdunn/Documents/roam-semantic-search/tests/integration/test_indexing.py", line 72, in mock_post
    raise Exception("API Error")
Exception: API Error
2025-05-30 16:22:10 [    INFO] Fetching blocks under TOC - ideas (indexing.py:95)
2025-05-30 16:22:10 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:11 [    INFO] Fetching block references (indexing.py:117)
2025-05-30 16:22:13 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:14 [    INFO] Creating embeddings (indexing.py:126)
2025-05-30 16:22:35 [    INFO] Creating FAISS index (indexing.py:130)
2025-05-30 16:22:35 [    INFO] Successfully reindexed ideas brain in 25.37 seconds (indexing.py:145)
2025-05-30 16:22:36 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:38 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:22:39 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:22:41 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:22:42 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:22:43 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:22:43 [    INFO] Fetching blocks under TOC - ideas (indexing.py:95)
2025-05-30 16:22:44 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:45 [    INFO] Fetching block references (indexing.py:117)
2025-05-30 16:22:46 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:22:48 [    INFO] Creating embeddings (indexing.py:126)
2025-05-30 16:23:07 [    INFO] Creating FAISS index (indexing.py:130)
2025-05-30 16:23:07 [    INFO] Successfully reindexed ideas brain in 24.41 seconds (indexing.py:145)
2025-05-30 16:23:07 [    INFO] Fetching blocks under TOC - ideas (indexing.py:95)
2025-05-30 16:23:09 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:23:10 [    INFO] Fetching block references (indexing.py:117)
2025-05-30 16:23:13 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:23:20 [    INFO] Creating embeddings (indexing.py:126)
2025-05-30 16:23:39 [    INFO] Creating FAISS index (indexing.py:130)
2025-05-30 16:23:39 [    INFO] Successfully reindexed ideas brain in 31.71 seconds (indexing.py:145)
2025-05-30 16:23:40 [    INFO] Fetching blocks under TOC - ideas (indexing.py:95)
2025-05-30 16:23:41 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:23:42 [    INFO] Fetching block references (indexing.py:117)
2025-05-30 16:23:43 [    INFO] HTTP Request: POST https://peer-13.api.roamresearch.com:3000/api/graph/unfamiliar/q "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:23:50 [    INFO] Creating embeddings (indexing.py:126)
2025-05-30 16:24:15 [    INFO] Creating FAISS index (indexing.py:130)
2025-05-30 16:24:15 [    INFO] Successfully reindexed ideas brain in 35.47 seconds (indexing.py:145)
2025-05-30 16:24:15 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:24:15 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:24:15 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 401 Unauthorized" (_client.py:1740)
2025-05-30 16:24:15 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'ideas'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:24:15 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:24:15 [    INFO] Request - Token: admin-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:24:15 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:24:15 [    INFO] Request - Token: marketing-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:24:15 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:24:15 [    INFO] Request - Token: marketing-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'ideas'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:24:15 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 403 Forbidden" (_client.py:1740)
2025-05-30 16:24:15 [    INFO] Request - Token: marketing-test-token, Method: POST, Endpoint: /api/search, Query Params: {}, Body: {'query': 'test', 'brain': 'marketing'}, Client: 127.0.0.1 (security.py:107)
2025-05-30 16:24:15 [    INFO] HTTP Request: POST http://test/api/search "HTTP/1.1 200 OK" (_client.py:1740)
2025-05-30 16:24:16 [ WARNING] Search validation error: Missing files: index, meta. Try reindexing first. (search.py:80)
2025-05-30 16:24:16 [   ERROR] Unexpected error during search (search.py:83)
Traceback (most recent call last):
  File "/Users/jamesdunn/Documents/roam-semantic-search/app/services/search.py", line 55, in search
    index = faiss.read_index(files["index"])
  File "/Users/jamesdunn/Documents/roam-semantic-search/tests/unit/services/test_search.py", line 64, in mock_read_index
    raise RuntimeError("FAISS error")
RuntimeError: FAISS error
